===========
Singularity
===========

:code:`bilby_pipe` is a lightweight code for setting up parameter estmation for
gravitational wave signals on the LIGO Data Grid clusters. The actual heavy
lifting of running parameter ensure provenance of results should be done in a
`singularity container
<https://www.sylabs.io/guides/2.6/user-guide/index.html>`_. These containers
can be thought of as a lightweight virtual machine which hosts the
:code:`bilby` software in an environment with all prerequisite software
installed. Using containers decreases the start-up difficulty and also
provenance of the results since we can know the versions of all software used
in the container.

:code:`singularity` is installed on all LIGO Data Grid clusters. To install it
on your local machine, see `the installation instructions
<https://www.sylabs.io/guides/2.6/user-guide/installation.html>`_.

Using the release container
---------------------------

By default, :code:`bilby_pipe` will run all code in a container matching the
release-version of the :code:`bilby_pipe` software that was called.  A release
containers is created for every :code:`bilby_pipe` release and available
through the `lscsoft/bilby_pipe singularity-hub landing page
<https://www.singularity-hub.org/collections/2050>`_.

Calling :code:`bilby_pipe` with an ini file :code:`config.ini`, one will see
something like the following message

.. code-block:: console

   $ bilby_pipe config.ini
   18:00 bilby_pipe INFO    : Setting use_singularity = True
   18:00 bilby_pipe INFO    : Downloading singularity image..
   singularity pull --name lscsoft-bilby_pipe:0.0.1.simg shub://lscsoft/bilby_pipe:0.0.1
   Progress |===================================| 100.0%
   Done. Container is at: /PATH/TO/PWD/lscsoft-bilby_pipe:0.0.1.simg

This will download the container image (with suffix :code:`simg`) to the
current working directory.

.. note::
   To see which version of the code you are using, call

   .. code-block:: console

      $ bilby_pipe --version

   If the output of :code:`bilby_pipe --version` contains something like

   .. code-block:: console

      bilby_pipe 0.0.1: (UNCLEAN) 3fd2820 2019-01-01 15:08:26 -0800

   rather than

   .. code-block:: console

      bilby_pipe 0.0.1:

   Then you have installed :code:`bilby_pipe` from source. Be wary that the
   release container version may not match that of the development code.

Using an alternative container
------------------------------

To use a different container, provide the path to the container to the
:code:`--simg` flag to :code:`bilby_pipe`.

.. warning::

   Every container requires an installation of :code:`bilby` and
   :code:`bilby_pipe` to succeed. This allows for the potential for the
   :code:`bilby_pipe` module inside the container to differ from your local
   install. For example, changes to your local copy of :code:`bilby` or
   :code:`bilby_pipe` will not be used by the container unless you explictly
   install the changes in the container (see `building a custom container`_).
   Version mismatches are checked at runtime and a warning is printed.

Using local installs of :code:`bilby` and :code:`bilby_pipe`
------------------------------------------------------------

To skip the use of containers all together, use the :code:`--no-singularity`
(or shorter :code:`-D`) flag. For this to succeed, you will need your local
python installation to have working :code:`bilby` and :code:`bilby_pipe`
modules. This option is useful for development and testing.


Building a custom container
---------------------------

Singularity images can be built in a number of ways. For full instructions,
please refer to the `official documentation
<https://www.sylabs.io/guides/2.6/user-guide/quick_start.html#build-images-from-scratch>`_.

Perhaps the cleanest way to generate an image is using a `container recipe
<https://www.sylabs.io/guides/2.6/user-guide/container_recipes.html>`_. For an
example, see the :code:`bilby_pipe` `release build recipe
<https://git.ligo.org/lscsoft/bilby_pipe/blob/master/containers/Singularity.0.0.1>`_.
Unfortunately, :code:`singularity` requires root access to build from a recipe.
As such, it is not possible to build recipes on the LIGO Data Grid clusters.
Instead, one can install a local copy of :code:`singularity`. Alternatively one
can use `singularity-hub <https://singularity-hub.org>`_ to set up automatic
building of containers from a connected github account.
